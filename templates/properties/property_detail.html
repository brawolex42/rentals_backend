{% extends "base.html" %}
{% load i18n l10n %}
{% block title %}{{ property.title }}{% endblock %}
{% block content %}

<section style="display:grid; grid-template-columns:1.2fr .8fr; gap:1rem;">
  <div style="display:grid; gap:1rem;">
    <article class="card">
      <div style="padding:1rem;">
        <h1 style="margin:0 0 .4rem; font-size:clamp(20px,3vw,28px);">{{ property.title }}</h1>
        <div class="muted" style="display:flex; gap:.6rem; flex-wrap:wrap;">
          {% if property.city %}<span>{{ property.city }}{% if property.display_district %}, {{ property.display_district }}{% endif %}</span>{% endif %}
        </div>
        <div style="display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-top:.6rem;">
          <span class="price">€ {% localize on %}{{ property.price|floatformat:2 }}{% endlocalize %}</span>
          <span class="rating">⭐ {{ property.rating_avg|floatformat:1|default:"—" }} ({{ property.reviews_total|default:"0" }})</span>
        </div>
      </div>
    </article>

    <article id="gallery" class="card" style="overflow:hidden;">
      <div style="padding:1rem;">
        <h2 style="margin:0 0 .6rem; font-size:1.1rem;">{% trans "Gallery" %}</h2>
        <div id="gallery-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:.75rem;">
          {% for img in property.images.all %}
            <img src="{{ img.image.url }}" alt="{{ property.title }}" style="width:100%; height:220px; object-fit:cover; border-radius:10px; cursor:pointer;" data-index="{{ forloop.counter0 }}">
          {% empty %}
            <div style="width:100%; height:220px; display:flex; align-items:center; justify-content:center;">{% trans "No photo" %}</div>
          {% endfor %}
        </div>
      </div>
    </article>

    <article id="reviews" class="card">
      <div style="padding:1rem;">
        <h2 style="margin:0 0 .6rem; font-size:1.1rem;">{% trans "Reviews" %}</h2>
        {% if reviews %}
          <div style="display:grid; gap:.6rem; margin:0 0 1rem;">
            {% for r in reviews %}
              <div class="card" style="padding:.75rem;">
                <div style="display:flex; justify-content:space-between; gap:.5rem;">
                  <strong>{{ r.display_user }}</strong>
                  <span class="rating">⭐ {{ r.rating }}</span>
                </div>
                {% if r.text %}
                  <div class="muted" style="margin-top:.35rem;">{{ r.text }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">{% trans "No reviews yet." %}</p>
        {% endif %}

        {% if request.user.is_authenticated and user_can_review %}
          <form method="post" action="{% url 'property_add_review' property.pk %}" style="display:grid; gap:.6rem; margin-top:.5rem;">
            {% csrf_token %}
            <div>
              <label for="rev_rating">{% trans "Your rating" %}</label>
              <select id="rev_rating" name="rating" required style="width:160px;">
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
              </select>
            </div>
            <div>
              <label for="rev_text">{% trans "Your review (optional)" %}</label>
              <textarea id="rev_text" name="text" rows="4"></textarea>
            </div>
            <div>
              <button type="submit" class="btn btn-primary">{% trans "Submit review" %}</button>
            </div>
          </form>
        {% endif %}
      </div>
    </article>
  </div>

  <div style="display:grid; gap:1rem;">
    <article id="book" class="card">
      <div style="padding:1rem;">
        <h2 style="margin:0 0 .6rem; font-size:1.1rem;">{% trans "Booking" %}</h2>

        {% if request.user.is_authenticated and user_booking %}
          <div class="alert alert-info" style="margin-bottom:.75rem;">
            {% trans "You already have an active booking:" %} {{ user_booking.start_date }} — {{ user_booking.end_date }}
          </div>
          <form method="post" action="{% url 'booking_cancel_html' user_booking.pk %}" style="margin:0 0 1rem;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">{% trans "Cancel my booking" %}</button>
          </form>
        {% endif %}

        {% if request.user.is_authenticated %}
          <form id="book-form" method="post" action="{% url 'property_book_now' property.pk %}" data-price-month="{{ property.price|unlocalize }}" style="display:grid; grid-template-columns:1fr 1fr; gap:.75rem; align-items:end;">
            {% csrf_token %}
            <div>
              <label for="check_in">{% trans "Check-in date" %}</label>
              <input id="check_in" name="check_in" type="date" value="{{ request.GET.start|default:'' }}" required>
            </div>
            <div>
              <label for="check_out">{% trans "Check-out date" %}</label>
              <input id="check_out" name="check_out" type="date" value="{{ request.GET.end|default:'' }}" required>
            </div>
            <div>
              <label for="guests">{% trans "Guests" %}</label>
              <input id="guests" name="guests" type="number" min="1" max="10" step="1" value="1" required>
            </div>
            <div>
              <label>{% trans "Price per night" %}</label>
              <div id="price_nightly" class="card" style="padding:.55rem .7rem;">—</div>
            </div>
            <div style="grid-column:1/-1; display:flex; justify-content:space-between; gap:.75rem;">
              <div style="flex:1;">
                <label>{% trans "Estimated total" %}</label>
                <div id="price_total" class="card" style="padding:.55rem .7rem;">—</div>
              </div>
              <div style="display:flex; align-items:end;">
                <button type="submit" class="btn btn-success" style="min-width:160px;">{% trans "Book now" %}</button>
              </div>
            </div>
          </form>
        {% else %}
          <a href="{% url 'login_page' %}?next={% url 'property_detail' property.pk %}#book" class="btn btn-primary">{% trans "Sign in to book" %}</a>
        {% endif %}
      </div>
    </article>

    <article id="contact" class="card">
      <div style="padding:1rem;">
        <h2 style="margin:0 0 .6rem; font-size:1.1rem;">{% trans "Contact host" %}</h2>
        <form id="contact-form" style="display:grid; grid-template-columns:1fr 1fr; gap:.75rem;">
          <div>
            <label for="c_name">{% trans "Your name" %}</label>
            <input id="c_name" name="name" type="text" required>
          </div>
          <div>
            <label for="c_email">{% trans "Your email" %}</label>
            <input id="c_email" name="email" type="email" required>
          </div>
          <div>
            <label for="c_phone">{% trans "Phone (optional)" %}</label>
            <input id="c_phone" name="phone" type="text">
          </div>
          <div style="grid-column:1/-1;">
            <label for="c_msg">{% trans "Message" %}</label>
            <textarea id="c_msg" name="message" rows="4" required></textarea>
          </div>
          <div style="grid-column:1/-1; display:flex; gap:.5rem; align-items:center;">
            <button type="submit" class="btn btn-muted">{% trans "Send message" %}</button>
            <span id="contact-status"></span>
          </div>
        </form>
      </div>
    </article>
  </div>
</section>

<div id="lightbox" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.9); justify-content:center; align-items:center; z-index:9999; opacity:0; transition:opacity .2s ease;">
  <button id="lb-close" style="position:absolute; top:16px; right:22px; font-size:32px; color:#fff; background:transparent; border:0; cursor:pointer; line-height:1;">×</button>
  <button id="lb-prev" style="position:absolute; left:12px; font-size:40px; color:#fff; background:transparent; border:0; cursor:pointer; line-height:1;">‹</button>
  <button id="lb-next" style="position:absolute; right:12px; font-size:40px; color:#fff; background:transparent; border:0; cursor:pointer; line-height:1;">›</button>
  <img id="lb-img" src="" style="max-width:92%; max-height:92%; border-radius:12px; transform:translateX(0); opacity:0;">
</div>

<style>
.lb-enter{opacity:0; transform:translateX(var(--dx,0)) scale(.98)}
.lb-enter-active{opacity:1; transform:translateX(0) scale(1); transition:opacity .22s ease, transform .22s ease}
.lb-exit{opacity:1; transform:translateX(0) scale(1)}
.lb-exit-active{opacity:0; transform:translateX(var(--dx,0)) scale(.98); transition:opacity .22s ease, transform .22s ease}
</style>

{# перевод, безопасный для вставки в JS #}
{% trans "nights" as nights_label %}

<script>
(function(){
  function parseD(v){if(!v)return null;var a=v.split("-");if(a.length!==3)return null;return new Date(+a[0],+a[1]-1,+a[2]);}
  function diffDays(a,b){var ms=24*60*60*1000;var d=Math.round((b-a)/ms);return d>0?d:0;}
  function fmt(n){return new Intl.NumberFormat(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}).format(n);}
  var form=document.getElementById("book-form");
  if(form){
    var priceMonth=Number(form.dataset.priceMonth||"0");
    var priceNight=priceMonth/30.0;
    var inEl=document.getElementById("check_in");
    var outEl=document.getElementById("check_out");
    var nightlyBox=document.getElementById("price_nightly");
    var totalBox=document.getElementById("price_total");
    function recalc(){
      nightlyBox.textContent=priceNight>0?"€ "+fmt(priceNight):"—";
      var s=parseD(inEl.value), e=parseD(outEl.value);
      if(!s||!e){totalBox.textContent="—";return;}
      var nights=diffDays(s,e);
      if(nights<=0){totalBox.textContent="—";return;}
      var total=priceNight*nights;
      totalBox.textContent="€ "+fmt(total)+" ("+nights+" {{ nights_label|escapejs }})";
    }
    ["change","input","blur"].forEach(function(ev){
      inEl.addEventListener(ev,recalc);
      outEl.addEventListener(ev,recalc);
    });
    recalc();
  }
})();
(function(){
  function getCookie(name){var v="; "+document.cookie;var p=v.split("; "+name+"=");if(p.length===2)return p.pop().split(";").shift();}
  var form=document.getElementById("contact-form");
  if(!form)return;
  var status=document.getElementById("contact-status");
  form.addEventListener("submit",function(e){
    e.preventDefault();
    status.textContent="";
    var payload={name:document.getElementById("c_name").value.trim(),email:document.getElementById("c_email").value.trim(),phone:document.getElementById("c_phone").value.trim(),message:document.getElementById("c_msg").value.trim()};
    fetch("/api/properties/{{ property.pk }}/contact/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken")||""},body:JSON.stringify(payload),credentials:"same-origin"})
      .then(function(r){return r.json().then(function(j){return{ok:r.ok,data:j};});})
      .then(function(res){if(res.ok){status.className="";status.style.color="";status.textContent="{% trans 'Message sent' %}";form.reset();}else{status.style.color="";status.textContent=(res.data&&res.data.detail)||"{% trans 'Failed to send' %}";}})
      .catch(function(){status.style.color="";status.textContent="{% trans 'Failed to send' %}";});
  });
})();
(function(){
  var grid=document.getElementById("gallery-grid");
  if(!grid)return;
  var imgs=[].slice.call(grid.querySelectorAll("img"));
  var box=document.getElementById("lightbox");
  var img=document.getElementById("lb-img");
  var btnPrev=document.getElementById("lb-prev");
  var btnNext=document.getElementById("lb-next");
  var btnClose=document.getElementById("lb-close");
  var idx=0;
  function setOpacity(o){box.style.opacity=o;}
  function openAt(i){
    if(i<0)i=imgs.length-1;
    if(i>=imgs.length)i=0;
    idx=i;
    img.style.transition="none";
    img.style.opacity="0";
    img.style.transform="translateX(0)";
    img.src=imgs[i].src;
    box.style.display="flex";
    requestAnimationFrame(function(){setOpacity(1);img.className="lb-enter-active";img.style.transition="opacity .22s ease, transform .22s ease";img.style.opacity="1";});
  }
  function slideTo(next){
    if(!imgs.length)return;
    var dir=next?1:-1;
    var to=idx+dir;
    if(to<0)to=imgs.length-1;
    if(to>=imgs.length)to=0;
    var dxOut=(dir>0?"-24px":"24px");
    var dxIn=(dir>0?"24px":"-24px");
    img.style.setProperty("--dx",dxOut);
    img.className="lb-exit-active";
    setTimeout(function(){
      img.style.transition="none";
      img.style.setProperty("--dx",dxIn);
      img.className="lb-enter";
      img.src=imgs[to].src;
      requestAnimationFrame(function(){
        img.className="lb-enter-active";
        img.style.transition="opacity .22s ease, transform .22s ease";
        idx=to;
      });
    },200);
  }
  imgs.forEach(function(it,i){
    it.addEventListener("click",function(){openAt(i);});
  });
  btnPrev.addEventListener("click",function(){slideTo(false);});
  btnNext.addEventListener("click",function(){slideTo(true);});
  btnClose.addEventListener("click",function(){setOpacity(0);setTimeout(function(){box.style.display="none";},200);});
  box.addEventListener("click",function(e){if(e.target===box){setOpacity(0);setTimeout(function(){box.style.display="none";},200);}});
  window.addEventListener("keydown",function(e){
    if(box.style.display!=="flex")return;
    if(e.key==="Escape"){setOpacity(0);setTimeout(function(){box.style.display="none";},200);}
    if(e.key==="ArrowLeft"){slideTo(false);}
    if(e.key==="ArrowRight"){slideTo(true);}
  });
})();
</script>

{% endblock %}
