{% extends "base.html" %}
{% load i18n l10n %}
{% block title %}{% trans "Find a cozy place to stay" %}{% endblock %}
{% block content %}

<section class="card" style="overflow:hidden; margin:0 0 1rem;">
  {% with p=properties|first %}
    {% if p and p.images.first and p.images.first.image %}
      <img src="{{ p.images.first.image.url }}" alt="" style="width:100%; height:260px; object-fit:cover;">
    {% endif %}
  {% endwith %}
  <div style="padding:clamp(20px,4vw,36px);">
    <h2 style="margin:0 0 .35rem; font-size:clamp(22px,4vw,34px);">{% trans "Find a cozy place to stay" %}</h2>
    <p class="muted" style="margin:0 0 .9rem;">{% trans "Browse options, book online, and manage bookings in one click." %}</p>
    <a href="#list" class="btn btn-success">{% trans "Go to catalog" %}</a>
    {% if not request.user.is_authenticated %}
      <a href="{% url 'register_page' %}" class="btn btn-primary" style="margin-left:.5rem;">{% trans "Register" %}</a>
    {% endif %}
  </div>
</section>

<a id="list"></a>
<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:1rem;">
  {% for property in properties %}
  <article class="card" style="display:flex; flex-direction:column; overflow:hidden;">
    {% with first=property.images.first %}
      {% if first and first.image %}
        <a href="{% url 'property_detail' property.pk %}">
          <img src="{{ first.image.url }}" alt="{{ property.title }}" style="width:100%; height:190px; object-fit:cover;">
        </a>
      {% else %}
        <div style="width:100%; height:190px; display:flex; align-items:center; justify-content:center;">{% trans "No photo" %}</div>
      {% endif %}
    {% endwith %}

    <div style="padding:1rem; display:flex; flex-direction:column; gap:.6rem;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
        <h3 style="margin:0; font-size:1.05rem;">
          <a href="{% url 'property_detail' property.pk %}" style="text-decoration:none;">{{ property.title }}</a>
        </h3>
        <div style="display:flex; gap:.35rem; flex-wrap:wrap;">
          {% if request.user.is_authenticated and property.user_booking %}
            <span class="badge">{% trans "Your booking" %}</span>
          {% elif property.other_booking %}
            <span class="badge">{% trans "Occupied" %}</span>
          {% else %}
            <span class="badge">{% trans "Available" %}</span>
          {% endif %}
          {% if request.user.is_authenticated and property.owner_id == request.user.id %}
            <span class="badge">{% trans "My property" %}</span>
          {% endif %}
        </div>
      </div>

      <div class="muted" style="display:flex; gap:.6rem; flex-wrap:wrap;">
        {% if property.city %}
          <span>{{ property.city }}{% if property.district and property.district|length > 2 %}, {{ property.district }}{% endif %}</span>
        {% endif %}
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; gap:.75rem;">
        <span class="price">
          {% localize on %}€ {{ property.price|floatformat:2 }}{% endlocalize %}
        </span>
        <span class="rating">
          ⭐ {{ property.rating_avg|floatformat:1|default_if_none:"—" }} ({{ property.reviews_total|default:"0" }})
        </span>
      </div>

      <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.1rem;">
        <a href="{% url 'property_detail' property.pk %}" class="pill">{% trans "Open" %}</a>
        <a href="{% url 'property_detail' property.pk %}#gallery" class="pill">{% trans "View" %}</a>
        {% if request.user.is_authenticated and not property.user_booking and not property.other_booking %}
          <a href="{% url 'property_detail' property.pk %}#book" class="pill">{% trans "Book now" %}</a>
        {% endif %}
        <a href="{% url 'property_detail' property.pk %}#contact" class="pill">{% trans "Contact host" %}</a>
        {% if request.user.is_authenticated and property.user_booking %}
          <a href="{% url 'booking_edit' property.user_booking.id %}" class="pill">{% trans "Manage booking" %}</a>
        {% endif %}
      </div>

      {% if request.user.is_authenticated and property.user_booking %}
        <div class="alert alert-info" style="margin-top:.25rem;">
          {% localize on %}
          {% blocktrans with start=property.user_booking.start_date|date:"DATE_FORMAT" end=property.user_booking.end_date|date:"DATE_FORMAT" %}
            Your booking dates: {{ start }} — {{ end }}
          {% endblocktrans %}
          {% endlocalize %}
        </div>
      {% endif %}
    </div>
  </article>
  {% empty %}
    <p>{% trans "No listings" %}</p>
  {% endfor %}
</div>
{% endblock %}
