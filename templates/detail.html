{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ property.title }}{% endblock %}

{% block content %}
<div style="display:flex; gap:2rem; flex-wrap:wrap;">
  <div style="flex:2; min-width:300px;">
    {% with imgs=property.images.all %}
      {% if imgs %}
        {% for image in imgs %}
          {% if image.image %}
            <img src="{{ image.image.url }}" alt="{{ property.title }}" style="width:100%; max-height:420px; object-fit:cover; margin-bottom:1rem;">
          {% endif %}
        {% endfor %}
      {% else %}
        <div style="width:100%; height:300px; display:flex; align-items:center; justify-content:center; background:#eee;">Нет фото</div>
      {% endif %}
    {% endwith %}
  </div>

  <div style="flex:1; min-width:280px;">
    <h2>{{ property.title }}</h2>
    <p>{% if property.city %}{{ property.city }}{% if property.district and property.district|length > 2 %}, {{ property.district }}{% endif %}{% endif %}</p>
    <p style="font-weight:bold;">{% if property.price %}{{ property.price }} €{% endif %}</p>
    <p>{{ property.description }}</p>
    <div style="margin-top:1rem;">
      <form action="{% url 'property_book_now' property.pk %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" style="padding:.6rem 1rem; background:#28a745; color:#fff; border-radius:5px; border:none;">Заселиться</button>
      </form>
    </div>
    <p style="margin-top:1rem;">⭐ {{ property.rating_avg|default_if_none:"—" }} ({{ property.reviews_total|default:"0" }})</p>
  </div>
</div>

<hr style="margin:2rem 0;">

<h3 style="margin:.5rem 0 1rem;">Отзывы</h3>

<div style="display:flex; flex-direction:column; gap:1rem; margin-bottom:1rem;">
  {% for r in property.reviews.all %}
    <div style="border:1px solid #ddd; border-radius:8px; padding:1rem; background:#fff;">
      <div style="font-weight:600;">⭐ {{ r.rating }}</div>
      <div style="margin-top:.25rem;">
        {% if r.text %}{{ r.text }}
        {% elif r.comment %}{{ r.comment }}
        {% elif r.content %}{{ r.content }}
        {% else %}—{% endif %}
      </div>
      {% if r.created_at %}<div style="color:#666; font-size:.9rem; margin-top:.25rem;">{{ r.created_at }}</div>{% endif %}
    </div>
  {% empty %}
    <div style="color:#666;">Пока нет отзывов.</div>
  {% endfor %}
</div>

{% if request.user.is_authenticated %}
<form action="{% url 'property_add_review' property.pk %}" method="post" style="border:1px solid #ddd; border-radius:8px; padding:1rem; background:#fbfbfb;">
  {% csrf_token %}
  <label for="rating" style="display:block; margin-bottom:.5rem;">Рейтинг (1–5):</label>
  <select id="rating" name="rating" required style="padding:.4rem; margin-bottom:1rem;">
    <option value="5">5 — отлично</option>
    <option value="4">4 — хорошо</option>
    <option value="3">3 — нормально</option>
    <option value="2">2 — плохо</option>
    <option value="1">1 — ужасно</option>
  </select>

  <label for="text" style="display:block; margin-bottom:.5rem;">Комментарий:</label>
  <textarea id="text" name="text" rows="4" required style="width:100%; padding:.6rem;"></textarea>

  <div style="margin-top:1rem;">
    <button type="submit" style="padding:.6rem 1rem; background:#007bff; color:#fff; border-radius:5px; border:none;">Отправить отзыв</button>
  </div>
</form>
{% else %}
<div style="border:1px solid #ffe0a3; background:#fff7e0; color:#6a4b00; padding:1rem; border-radius:.5rem;">
  Войдите, чтобы оставить отзыв. <a href="{% url 'admin:login' %}">Войти</a>
</div>
{% endif %}
{% endblock %}
