{% load static %}
<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ –∞—Ä–µ–Ω–¥—ã ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="{% static 'users.css' %}" rel="stylesheet" />
  <link rel="icon" href="{% static 'favicon.ico' %}">
</head>
<body>
  <header class="container header">
    <div class="brand">
      <h1 data-i18n="title">üè† –ê—Ä–µ–Ω–¥–∞ –∂–∏–ª—å—è ‚Äî –∫–∞—Ç–∞–ª–æ–≥</h1>
      <p class="muted" data-i18n="subtitle">–°–º–æ—Ç—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —Å —Ñ–æ—Ç–æ, —Ü–µ–Ω–æ–π –∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–º</p>
    </div>

    <div class="header-actions">
      <form id="langForm" action="/i18n/setlang/" method="post" class="lang-switcher">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path|default:'/' }}" />
        <select name="language" id="languageSelect">
          <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          <option value="de">üá©üá™ Deutsch</option>
          <option value="en">üá¨üáß English</option>
        </select>
      </form>

      <button id="themeBtn" class="button outline" type="button">üé® –¢–µ–º–∞</button>
    </div>
  </header>

  <section class="container searchbar">
    <form id="searchForm" onsubmit="return false;">
      <input type="search" id="q" placeholder="–ì–æ—Ä–æ–¥, —Ä–∞–π–æ–Ω –∏–ª–∏ –∞–¥—Ä–µ—Å" data-i18n-placeholder="search_placeholder" />
      <input type="number" id="minPrice" min="0" step="50" placeholder="–ú–∏–Ω. —Ü–µ–Ω–∞" data-i18n-placeholder="min_price" />
      <input type="number" id="maxPrice" min="0" step="50" placeholder="–ú–∞–∫—Å. —Ü–µ–Ω–∞" data-i18n-placeholder="max_price" />
      <select id="rooms">
        <option value="" data-i18n="rooms_any">–ö–æ–º–Ω–∞—Ç</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5+</option>
      </select>
      <button class="button primary" id="applySearch" type="button" data-i18n="find">–ù–∞–π—Ç–∏</button>
      <button class="button outline" id="resetSearch" type="button" data-i18n="reset">–°–±—Ä–æ—Å</button>
    </form>
  </section>

  <main class="container">
    <div class="grid" id="cards">
      {% for p in properties %}
      <article class="card"
               data-city="{{ p.city|default:'' }}"
               data-district="{{ p.district|default:'' }}"
               data-address="{{ p.address|default:'' }}"
               data-price="{{ p.price|default:0 }}"
               data-rooms="{{ p.rooms|default:0 }}">

        <a class="thumb" href="{% url 'property_detail' p.pk %}" aria-label="{{ p.title }}">
          {% with first=p.images.first %}
            {% if first and first.image %}
              <img src="{{ first.image.url }}" alt="{{ first.alt|default:p.title }}" loading="lazy">
            {% else %}
              <div class="placeholder">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
            {% endif %}
          {% endwith %}
          {% if p.get_property_type_display %}
            <div class="badge">{{ p.get_property_type_display }}</div>
          {% endif %}
        </a>

        <div class="card-body">
          <h3 class="title" title="{{ p.title }}">
            <a href="{% url 'property_detail' p.pk %}">{{ p.title|default:"–û–±—ä—è–≤–ª–µ–Ω–∏–µ"|truncatechars:60 }}</a>
          </h3>
          <p class="sub">
            {% if p.city %}{{ p.city }}{% if p.district %}, {{ p.district }}{% endif %}{% endif %}
          </p>

          <div class="meta">
            <span class="price">
              {% if p.price %}‚Ç¨ {{ p.price }}{% else %}<span data-i18n="price_on_request">–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É</span>{% endif %}
            </span>
            {% if p.rooms %}<span class="rooms">{{ p.rooms }} <span data-i18n="rooms_suffix">–∫–æ–º–Ω.</span></span>{% endif %}
            {% if p.area %}<span class="area">{{ p.area }} –º¬≤</span>{% endif %}
          </div>

          <div class="rating">‚≠ê {{ p.rating_avg|default_if_none:"‚Äî" }} ({{ p.reviews_total|default:"0" }})</div>

          <div class="actions">
            <a class="button" href="{% url 'property_detail' p.pk %}" data-i18n="open">–û—Ç–∫—Ä—ã—Ç—å</a>
            <a class="button outline" href="{% url 'property_detail' p.pk %}" data-i18n="preview">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>
            <form action="{% url 'property_book_now' p.pk %}" method="post" style="display:inline;">
              {% csrf_token %}
              <button class="button primary" type="submit" data-i18n="checkin">–ó–∞—Å–µ–ª–∏—Ç—å—Å—è</button>
            </form>
          </div>
        </div>
      </article>
      {% empty %}
        <p data-i18n="empty">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π.</p>
      {% endfor %}
    </div>
  </main>

  <footer class="container muted">
    <p><span data-i18n="public_note">–ü—É–±–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ú–µ–¥–∏–∞ –±–µ—Ä—É—Ç—Å—è –∏–∑</span> {{ MEDIA_URL }}.</p>
  </footer>

  <script>
    const dict = {
      ru: {
        title: "üè† –ê—Ä–µ–Ω–¥–∞ –∂–∏–ª—å—è ‚Äî –∫–∞—Ç–∞–ª–æ–≥",
        subtitle: "–°–º–æ—Ç—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —Å —Ñ–æ—Ç–æ, —Ü–µ–Ω–æ–π –∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–º",
        search_placeholder: "–ì–æ—Ä–æ–¥, —Ä–∞–π–æ–Ω –∏–ª–∏ –∞–¥—Ä–µ—Å",
        min_price: "–ú–∏–Ω. —Ü–µ–Ω–∞",
        max_price: "–ú–∞–∫—Å. —Ü–µ–Ω–∞",
        rooms_any: "–ö–æ–º–Ω–∞—Ç",
        find: "–ù–∞–π—Ç–∏",
        reset: "–°–±—Ä–æ—Å",
        price_on_request: "–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É",
        rooms_suffix: "–∫–æ–º–Ω.",
        open: "–û—Ç–∫—Ä—ã—Ç—å",
        preview: "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å",
        checkin: "–ó–∞—Å–µ–ª–∏—Ç—å—Å—è",
        empty: "–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π.",
        public_note: "–ü—É–±–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ú–µ–¥–∏–∞ –±–µ—Ä—É—Ç—Å—è –∏–∑"
      },
      de: {
        title: "üè† Mietkatalog ‚Äî Wohnungen & H√§user",
        subtitle: "Sehen Sie verf√ºgbare Objekte mit Fotos, Preis und Bewertung",
        search_placeholder: "Stadt, Bezirk oder Adresse",
        min_price: "Min. Preis",
        max_price: "Max. Preis",
        rooms_any: "Zimmer",
        find: "Suchen",
        reset: "Zur√ºcksetzen",
        price_on_request: "Preis auf Anfrage",
        rooms_suffix: "Zi.",
        open: "√ñffnen",
        preview: "Ansehen",
        checkin: "Einziehen",
        empty: "Noch keine aktiven Inserate.",
        public_note: "√ñffentliche Seite f√ºr Nutzer. Medien von"
      },
      en: {
        title: "üè† Rentals Catalog",
        subtitle: "Browse available listings with photos, price and rating",
        search_placeholder: "City, district or address",
        min_price: "Min price",
        max_price: "Max price",
        rooms_any: "Rooms",
        find: "Search",
        reset: "Reset",
        price_on_request: "Price on request",
        rooms_suffix: "rm.",
        open: "Open",
        preview: "Preview",
        checkin: "Check in",
        empty: "No active listings yet.",
        public_note: "Public page for users. Media from"
      }
    };

    function applyLang(lang){
      const d = dict[lang] || dict.ru;
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        if(d[k] !== undefined){ el.textContent = d[k]; }
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
        const k = el.getAttribute("data-i18n-placeholder");
        if(d[k] !== undefined){ el.setAttribute("placeholder", d[k]); }
      });
      localStorage.setItem("ui_lang", lang);
    }

    const themeOrder = ["light","dark","emerald","royal"];
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("ui_theme", theme);
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      const savedLang = localStorage.getItem("ui_lang") || "ru";
      const select = document.getElementById("languageSelect");
      select.value = savedLang;
      applyLang(savedLang);
      select.addEventListener("change", ()=>{ document.getElementById("langForm").submit(); });

      const savedTheme = localStorage.getItem("ui_theme") || "light";
      applyTheme(savedTheme);
      document.getElementById("themeBtn").addEventListener("click", ()=>{
        const cur = document.documentElement.getAttribute("data-theme") || "light";
        const idx = themeOrder.indexOf(cur);
        const next = themeOrder[(idx+1)%themeOrder.length];
        applyTheme(next);
      });

      const cards = Array.from(document.querySelectorAll('#cards .card'));
      function norm(s){ return (s||'').toString().toLowerCase(); }
      function applyFilters(){
        const q = norm(document.getElementById('q').value);
        const min = parseInt(document.getElementById('minPrice').value||'0',10);
        const max = parseInt(document.getElementById('maxPrice').value||'0',10);
        const rooms = document.getElementById('rooms').value;
        cards.forEach(card=>{
          const city = norm(card.dataset.city);
          const district = norm(card.dataset.district);
          const address = norm(card.dataset.address);
          const price = parseInt(card.dataset.price||'0',10);
          const r = card.dataset.rooms || '';
          let ok = true;
          if(q){ ok = (city.includes(q) || district.includes(q) || address.includes(q)); }
          if(ok && min){ ok = price>=min; }
          if(ok && max){ ok = price<=max; }
          if(ok && rooms){
            if(rooms==='5+') ok = parseInt(r||'0',10) >= 5;
            else ok = (r === rooms);
          }
          card.style.display = ok ? '' : 'none';
        });
      }
      document.getElementById('applySearch').addEventListener('click', applyFilters);
      document.getElementById('resetSearch').addEventListener('click', ()=>{
        document.getElementById('q').value='';
        document.getElementById('minPrice').value='';
        document.getElementById('maxPrice').value='';
        document.getElementById('rooms').value='';
        cards.forEach(c=>c.style.display='');
      });
    });
  </script>
</body>
</html>
